<tool id="validation_image_metadata" name="validation_image_metadata" version="1.0">
    <macros>
        <!-- Tests are not executed if they have no output checks, thus define a dummy check -->
        <xml name="test-output">
            <output name="output">
                <assert_contents>
                    <has_size value="0" delta="0" />
                </assert_contents>
            </output>
        </xml>
   </macros>
    <command><![CDATA[
      cat /dev/null > testfile
    ]]></command>
    <inputs>
        <!-- Checks for "axes" metadata -->
        <param name="input_axes_yx" type="data" format="data" optional="true">
            <validator type="dataset_metadata_equal" metadata_name="axes" value="YX" />
        </param>
        <param name="input_axes_yxc" type="data" format="data" optional="true">
            <validator type="dataset_metadata_equal" metadata_name="axes" value="YXC" />
        </param>
        <param name="input_axes_zcyx" type="data" format="data" optional="true">
            <validator type="dataset_metadata_equal" metadata_name="axes" value="ZCYX" />
        </param>
        <!-- Checks for "dtype" metadata -->
        <param name="input_dtype_uint8" type="data" format="data" optional="true">
            <validator type="dataset_metadata_equal" metadata_name="dtype" value="uint8" />
        </param>
        <param name="input_dtype_uint16" type="data" format="data" optional="true">
            <validator type="dataset_metadata_equal" metadata_name="dtype" value="uint16" />
        </param>
        <param name="input_dtype_float64" type="data" format="data" optional="true">
            <validator type="dataset_metadata_equal" metadata_name="dtype" value="float64" />
        </param>
        <!-- Checks for "num_unique_values" metadata -->
        <param name="input_num_unique_values_1" type="data" format="data" optional="true">
            <validator type="dataset_metadata_equal" metadata_name="num_unique_values" value_json="1" />
        </param>
        <param name="input_num_unique_values_2" type="data" format="data" optional="true">
            <validator type="dataset_metadata_equal" metadata_name="num_unique_values" value_json="2" />
        </param>
        <param name="input_num_unique_values_618" type="data" format="data" optional="true">
            <validator type="dataset_metadata_equal" metadata_name="num_unique_values" value_json="618" />
        </param>
        <!-- Checks for "width" metadata -->
        <param name="input_width_16" type="data" format="data" optional="true">
            <validator type="dataset_metadata_equal" metadata_name="width" value_json="16" />
        </param>
        <param name="input_width_32" type="data" format="data" optional="true">
            <validator type="dataset_metadata_equal" metadata_name="width" value_json="32" />
        </param>
        <!-- Checks for "height" metadata -->
        <param name="input_height_8" type="data" format="data" optional="true">
            <validator type="dataset_metadata_equal" metadata_name="height" value_json="8" />
        </param>
        <param name="input_height_32" type="data" format="data" optional="true">
            <validator type="dataset_metadata_equal" metadata_name="height" value_json="32" />
        </param>
        <!-- Checks for "channels" metadata -->
        <param name="input_channels_0" type="data" format="data" optional="true">
            <validator type="dataset_metadata_equal" metadata_name="channels" value_json="0" />
        </param>
        <param name="input_channels_2" type="data" format="data" optional="true">
            <validator type="dataset_metadata_equal" metadata_name="channels" value_json="2" />
        </param>
        <param name="input_channels_3" type="data" format="data" optional="true">
            <validator type="dataset_metadata_equal" metadata_name="channels" value_json="3" />
        </param>
        <!-- Checks for "depth" metadata -->
        <param name="input_depth_0" type="data" format="data" optional="true">
            <validator type="dataset_metadata_equal" metadata_name="depth" value_json="0" />
        </param>
        <param name="input_depth_25" type="data" format="data" optional="true">
            <validator type="dataset_metadata_equal" metadata_name="depth" value_json="25" />
        </param>
        <!-- Checks for "frames" metadata -->
        <param name="input_frames_0" type="data" format="data" optional="true">
            <validator type="dataset_metadata_equal" metadata_name="frames" value_json="0" />
        </param>
        <param name="input_frames_1" type="data" format="data" optional="true">
            <validator type="dataset_metadata_equal" metadata_name="frames" value_json="1" />
        </param>
        <param name="input_frames_5" type="data" format="data" optional="true">
            <validator type="dataset_metadata_equal" metadata_name="frames" value_json="5" />
        </param>
        <!-- Checks for TIFF files with multiple pages -->
        <param name="input_multipage_tiff" type="data" format="data" optional="true">
            <validator type="dataset_metadata_equal" metadata_name="axes" value_json='["YXS", "YX"]' />
            <validator type="dataset_metadata_equal" metadata_name="dtype" value_json='["uint8", "uint16"]' />
            <validator type="dataset_metadata_equal" metadata_name="num_unique_values" value_json="[2, 255]" />
            <validator type="dataset_metadata_equal" metadata_name="width" value_json="[32, 256]" />
            <validator type="dataset_metadata_equal" metadata_name="height" value_json="[32, 256]" />
            <validator type="dataset_metadata_equal" metadata_name="channels" value_json="[3, 0]" />
            <validator type="dataset_metadata_equal" metadata_name="depth" value_json="[0, 0]" />
            <validator type="dataset_metadata_equal" metadata_name="frames" value_json="[0, 0]" />
        </param>
        <!-- Checks for failing metadata extraction -->
        <param name="input_unsupported_tiff_compression" type="data" format="data" optional="true">
            <!-- If the compression of a TIFF is unsupported, the fields "axes" and "dtype" should still be there -->
            <validator type="dataset_metadata_equal" metadata_name="axes" value="YX" />
            <validator type="dataset_metadata_equal" metadata_name="dtype" value="bool" />
            <validator type="dataset_metadata_equal" metadata_name="width" value_json="1728" />
            <validator type="dataset_metadata_equal" metadata_name="height" value_json="2376" />
            <validator type="dataset_metadata_equal" metadata_name="channels" value_json="0" />
            <validator type="dataset_metadata_equal" metadata_name="depth" value_json="0" />
            <validator type="dataset_metadata_equal" metadata_name="frames" value_json="0" />
            <!-- The other fields should be missing -->
            <validator type="dataset_metadata_equal" metadata_name="num_unique_values" value="" />
        </param>
        <param name="input_no_metadata" type="data" format="data" optional="true">
            <validator type="dataset_metadata_equal" metadata_name="axes" value="" />
            <validator type="dataset_metadata_equal" metadata_name="dtype" value="" />
            <validator type="dataset_metadata_equal" metadata_name="num_unique_values" value="" />
            <validator type="dataset_metadata_equal" metadata_name="width" value="" />
            <validator type="dataset_metadata_equal" metadata_name="height" value="" />
            <validator type="dataset_metadata_equal" metadata_name="channels" value="" />
            <validator type="dataset_metadata_equal" metadata_name="depth" value="" />
            <validator type="dataset_metadata_equal" metadata_name="frames" value="" />
        </param>
    </inputs>
    <outputs>
        <data name="output" format="data" />
    </outputs>
    <tests>
        <!-- Tests with TIFF files -->
        <test>
            <param name="input_axes_yx" value="im1_uint8.tif" />
            <param name="input_axes_zcyx" value="im6_uint8.tif" />
            <param name="input_dtype_uint8" value="im6_uint8.tif" />
            <param name="input_dtype_uint16" value="im8_uint16.tif" />
            <param name="input_dtype_float64" value="im4_float.tif" />
            <param name="input_num_unique_values_2" value="im3_b.tif" />
            <param name="input_num_unique_values_618" value="im4_float.tif" />
            <param name="input_width_16" value="im7_uint8.tif" /><!-- axes: ZYX -->
            <param name="input_width_32" value="im3_b.tif" /><!-- axes: YXS -->
            <param name="input_height_8" value="im7_uint8.tif" /><!-- axes: ZYX -->
            <param name="input_height_32" value="im3_b.tif" /><!-- axes: YXS -->
            <param name="input_channels_0" value="im1_uint8.tif" />
            <param name="input_channels_2" value="im5_uint8.tif" /><!-- axes: CYX -->
            <param name="input_channels_3" value="im3_b.tif" /><!-- axes: YXS -->
            <param name="input_depth_0" value="im1_uint8.tif" /><!-- axes: YXS -->
            <param name="input_depth_25" value="im7_uint8.tif" /><!-- axes: ZYX -->
            <param name="input_frames_0" value="im1_uint8.tif" /><!-- axes: YXS -->
            <param name="input_frames_5" value="im8_uint16.tif" /><!-- axes: TYX -->
            <param name="input_multipage_tiff" value="im9_multipage.tif" />
            <param name="input_unsupported_tiff_compression" value="1.tiff" />
            <expand macro="test-output" />
        </test>
        <!-- Tests with PNG files -->
        <test>
            <param name="input_axes_yx" value="im1_uint8.png" />
            <param name="input_axes_yxc" value="im3_a.png" />
            <param name="input_dtype_uint8" value="im1_uint8.png" />
            <param name="input_num_unique_values_1" value="im2_a.png" />
            <param name="input_num_unique_values_2" value="im2_b.png" />
            <param name="input_width_32" value="im2_b.png" />
            <param name="input_height_32" value="im2_b.png" />
            <param name="input_channels_0" value="im1_uint8.png" />
            <param name="input_channels_3" value="im3_a.png" />
            <param name="input_depth_0" value="im1_uint8.png" />
            <param name="input_frames_1" value="im1_uint8.png" />
            <expand macro="test-output" />
        </test>
        <!-- Test for failing metadata extraction -->
        <test>
            <param name="input_no_metadata" value="im_empty.tif" />
            <expand macro="test-output" />
        </test>
        <test>
            <param name="input_no_metadata" value="im_corrupted.tif" />
            <expand macro="test-output" />
        </test>
        <!-- End of tests -->
    </tests>
</tool>
