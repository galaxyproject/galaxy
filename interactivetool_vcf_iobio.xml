<tool id="interactive_tool_vcf_iobio" tool_type="interactive" name="VCF (iobio) Visualisation" version="0.1">
    <requirements>
        <container type="docker">qiaoy/iobio-bundle.vcf-iobio:dev-ondemand</container>
    </requirements>
    <entry_points>
        <entry_point name="VCF io.bio visualisation of $infile.display_name" requires_domain="True">
            <port>80</port>
            <url><![CDATA[/?bam=http://localhost/tmp/bamfile.bam&region=1]]></url>
        </entry_point>
    </entry_points>
    <command><![CDATA[
    ## ToDo: websocket could not be found
    ## WebSocket connection to 'ws://localhost/bamreaddepther/' failed: Error in connection establishment: net::ERR_CONNECTION_REFUSED

    #set $PUB_HOSTNAME = 'localhost'
    #set $PUB_HTTP_PORT = '80'

    cd /var/www/html &&
    ##sed -i "s@\"wss://services.iobio.io/samtools/\"@((window.location.protocol === \"https:\") ? \"wss://\" : \"ws://\") + window.location.host + \"/samtools/\"@" app/bam.iobio.js &&
    ##sed -i "s@\"wss://services.iobio.io/bamreaddepther/\"@((window.location.protocol === \"https:\") ? \"wss://\" : \"ws://\") + window.location.host + \"/bamreaddepther/\"@" app/bam.iobio.js &&
    sed -i "s@\"wss://services.iobio.io/vcfdepther/\"@((window.location.protocol === \"https:\") ? \"wss://\" : \"ws://\") + window.location.host + \"/vcfdepther/\"@" app/vcf.iobio.js &&
    sed -i "s@\"wss://services.iobio.io/vcfstatsalive/\"@((window.location.protocol === \"https:\") ? \"wss://\" : \"ws://\") + window.location.host + \"/vcfstatsalive/\"@" app/vcf.iobio.js &&
    ##sed -i "s@\"wss://services.iobio.io/bamstatsalive/\"@((window.location.protocol === \"https:\") ? \"wss://\" : \"ws://\") + window.location.host + \"/bamstatsalive/\"@" app/bam.iobio.js &&
    sed -i "s@\"wss://services.iobio.io/tabix/\"@((window.location.protocol === \"https:\") ? \"wss://\" : \"ws://\") + window.location.host + \"/tabix/\"@" app/vcf.iobio.js &&


##s@ws://tabix.iobio.io@ws://" + window.location.hostname + ":8000@
##s@ws://vcfreaddepther.iobio.io@ws://" + window.location.hostname + ":8001@
##s@ws://vcfstatsalive.iobio.io@ws://" + window.location.hostname + ":8002@


        sed -i 's/deny all;//g' /etc/nginx/nginx.conf &&

        cp '${infile}' /input/vcffile.vcf &&
        ##cp '${infile.metadata.bam_index}' /input/vcffile.bam.bai &&
        mkdir /var/log/supervisor/ &&
        head -n -2  /etc/supervisor.d/app.conf > /tmp/app.conf &&
        mv /tmp/app.conf /etc/supervisor.d/app.conf &&

        /usr/bin/supervisord -c /etc/supervisord.conf
    ]]>
    </command>
    <inputs>
        <param name="infile" type="data" format="vcf" label="VCF file"/>
    </inputs>
    <outputs>
        <data name="outfile" format="txt" />
    </outputs>
    <tests>
    </tests>
    <help>
        VCF iobio visualisation.
    </help>
</tool>
