<tool id="GeneBed_Maf_Fasta2" name="Stitch Gene blocks">
  <description>given a set of coding exon intervals</description>
  <command interpreter="python2.4">#if $maf_source_type.maf_source == "user":#interval_maf_to_merged_fasta.py --dbkey=$dbkey --species=$maf_source_type.species --mafSource=$maf_source_type.maf_file --interval_file=$input1 --output_file=$out_file1 --mafSourceType=$maf_source_type.maf_source --geneBED
#else:#interval_maf_to_merged_fasta.py --dbkey=$dbkey --species=$maf_source_type.species --mafSource=$maf_source_type.maf_identifier --interval_file=$input1 --output_file=$out_file1 --mafSourceType=$maf_source_type.maf_source  --geneBED
#end if
  </command>
  <inputs>
    <param name="input1" type="data" format="bed" label="Gene BED File">
      <validator type="unspecified_build" />
    </param>
    <conditional name="maf_source_type">
      <param name="maf_source" type="select" label="MAF Source">
        <option value="cached" selected="true">Locally Cached Alignments</option>
        <option value="user">Alignments in Your History</option>
      </param>
      <when value="user">
        <param name="maf_file" type="data" format="maf" label="MAF File">
          <validator type="dataset_ok_validator" />
        </param>
        <param name="species" type="select" display="checkboxes" multiple="true" label="Choose species" help="Select species to be included in the final alignment">
          <options>
            <filter type="data_meta" data_ref="maf_file" />
            <filter type="param" name="maf_source" value="user" />
          </options>
        </param>
      </when>
      <when value="cached">
        <param name="maf_identifier" type="select" label="MAF Type" >
          <options from_file="/depot/data2/galaxy/maf_index.loc" name_col="0" value_col="1">
            <validator type="no_options" message="No alignments are available for the build associated with the selected gene bed file"/>
            <filter type="data_meta" data_ref="input1" meta_key="dbkey" meta_key_col="2"/>
          </options>
        </param> 
        <param name="species" type="select" display="checkboxes" multiple="true" label="Choose species" help="Select species to be included in the final alignment">
          <options from_file="/depot/data2/galaxy/maf_index.loc">
            <filter type="param_meta" param_ref="maf_identifier" />
            <filter type="param" name="maf_source" value="cached" />
          </options>
        </param>
      </when>
    </conditional>
   </inputs>
  <outputs>
    <data format="fasta" name="out_file1" />
  </outputs>
  <tests>
    <test>
      <param name="input1" value="8.bed"/>
      <param name="maf_source" value="cached"/>
      <param name="maf_identifier" value="8_WAY_MULTIZ_hg17"/>
      <param name="species" value="canFam1,hg17,mm5,panTro1,rn3"/>
      <output name="out_file1" file="gene_bed_maf_to_fasta_out.fasta" />
    </test>
    <test>
      <param name="input1" value="8.bed"/>
      <param name="maf_source" value="user"/>
      <param name="maf_file" value="4.maf"/>
      <param name="species" value="hg17,panTro1"/>
      <output name="out_file1" file="gene_bed_maf_to_fasta_user_out.fasta" />
    </test>
  </tests> 
  <help>

**What it does**

The coding sequence of genes are usually composed of several coding exons. Each of these coding exons is an individual genomic region, which when concatenated with each other constitutes the coding sequence. A single genomic region can be covered by multiple alignment blocks. In many cases it is desirable to stitch these alignment blocks together. This tool accepts a list of gene-based intervals, in the Gene BED format. For every interval it performs the following:

  * finds all MAF blocks that overlap the coding regions;
  * sorts MAF blocks by alignment score;
  * stitches blocks together and resolves overlaps based on alignment score;
  * outputs alignments in FASTA format.


  </help>
</tool>
